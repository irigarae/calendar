<!DOCTYPE html>
<html>
<head>
  <title>Calendario</title>
  <style type="text/css">
    @media print {
      body {
        margin: 0;
        padding: 0;
      }
      #setup {
        display: none; 
      }
    }
    @media screen {
      table {
        margin: 0 0 2em 0;
      }
    }
    * {
      box-sizing: border-box;
    }
    section > table {
      width: 28.7cm;
      height: 21cm;
    }
    table:last-child {
      page-break-after: initial;
    }
    table {
      page-break-inside: avoid;
      page-break-after: always;
      table-layout: fixed;
      border-collapse: collapse;
      font-family: -apple-system, BlinkMacSystemFont;
      font-variant-numeric: tabular-nums;
    }
    thead th {
      height: 1cm;
      vertical-align: middle;
      font-size: x-large;
    }
    thead th[colspan] {
      height: 4cm;
      font-size: 1.8cm;
      line-height: 3.4cm;
    }
    td, th {
      border: 1px solid black;
    }
    td {
      text-align: right;
      vertical-align: top;
      padding: 1mm;
      height: 2.5cm;
      font-size: x-large;
    }
    .mini {
      font-size: initial;
      border-collapse: initial;
      margin: 0 5mm;
      width: 5cm;
      line-height: initial;
      font-weight: initial;
    }
    .mini td, .mini th {
      border: initial;
      padding: 0;
      height: initial;
      font-size: initial;
    }
    .mini:first-child {
      float: left;
    }
    .mini:last-child {
      float: right;
    }
    .mini thead th[colspan] {
      height: initial;
    }
    .mini th {
      height: initial;
      /*text-align: right;*/
    }
    .festivo, td:last-child {
      color: #DF3232;
    }
    span {
      position: relative;
    }
    svg {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translate(20%, calc(-50% + 1px)) scale(.56);
    }
  </style>
  <script type="text/javascript">
    const anyo = new Date().getYear() + 1901; // por defecto el anyo siguiente
    // esto es para que configures, mamÃ¡
    const festivos = {
      enero: [6],
febrero: [],
marzo: [],
abril: [6,7],
mayo: [1],
junio: [],
julio: [],
agosto: [15],
septiembre: [],
octubre: [12],
noviembre: [1],
diciembre: [6,8,25],
    };
    let primeraLuna = "llena"; // nueva creciente llena menguante
    const lunas = {
      enero: [7,15,21,28],
febrero: [5,13,20,27],
marzo: [7,15,21,29],
abril: [6,13,20,27],
mayo: [5,12,19,27],
junio: [4,10,18,26],
julio: [3,10,17,26],
agosto: [1,8,16,24,31],
septiembre: [7,15,22,29],
octubre: [6,14,22,28],
noviembre: [5,13,20,27],
diciembre: [5,12,19,27],
    };

    // de aquÃ­ para abajo no tendrÃ­as que tocar nada
    const nombreMeses = [
      "enero",
      "febrero",
      "marzo",
      "abril",
      "mayo",
      "junio",
      "julio",
      "agosto",
      "septiembre",
      "octubre",
      "noviembre",
      "diciembre",
    ];
    const nombreDias = [
      "lunes",
      "martes",
      "miÃ©rcoles",
      "jueves",
      "viernes",
      "sÃ¡bado",
      "domingo",
    ];
    const letrasDias = [..."LMXJVSD"];
    const posiblesLunas = {
      nueva: // "ðŸŒ‘",
        `<svg width="50" height="50">
          <circle cx="25" cy="25" r="16" fill="#000000" stroke="#000000" stroke-width="3"/>
        </svg>`,
      creciente: // "ðŸŒ’ðŸŒ“ðŸŒ”",
        `<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50">
          <circle stroke-width="3" stroke="#000000" fill="none" r="16" cy="25" cx="25"/>
          <path stroke-width="0" fill="black" d="m25,9a16,16 0 0 0 0,32l0,-1.5a18,18 0 0 0 0,-29l0,-1.5z"/>
        </svg>`,
      llena: // "ðŸŒ•",
        `<svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="50" height="50">
          <circle cx="25" cy="25" r="16" fill="none" stroke="#000000" stroke-width="3"/>
        </svg>`,
      menguante: // "ðŸŒ–ðŸŒ—ðŸŒ˜",
        `<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50">
          <circle stroke-width="3" stroke="#000000" fill="none" r="16" cy="25" cx="25"/>
          <path stroke-width="0" fill="black" d="m25,9a16,16 0 0 1 0,32l0,-1.5a18,18 0 0 1 0,-29l0,-1.5z"/>
        </svg>`,
    }

    window.addEventListener('load', () => document.body.appendChild(calendario(anyo)));

    function calendario(anyo) {
      const opciones = obtenerOpciones();
      if (opciones.has("anyo")) {
        anyo = opciones.get("anyo");
      }
      const section = document.createElement('section');
      section.title = anyoId(anyo);
      nombreMeses
      .map((nombre, n) => mes(anyo, n, nombre))
      .forEach((mes) => section.appendChild(mes));
      return section;
    }

    function obtenerOpciones() {
      if (location.search) {
        const conEnye = new URL(document.location).searchParams;
        return new Map(conEnye);
      } else {
        return new Map();
      }
    }

    function mes(anyo, mes, nombre) {
      const tabla = document.createElement('table');
      tabla.title = mesId(anyo, mes);
      tabla.appendChild(cabecera(anyo, mes, nombre));
      tabla.appendChild(dias(anyo, mes));
      return tabla;
    }

    function diaId(anyo, mes, dia) {
      return anyo.toString().padStart(4, "0") + "-" + (mes + 1).toString().padStart(2, "0") + "-" + dia.toString().padStart(2, "0");
    }

    function mesId(anyo, mes) {
      return anyo.toString().padStart(4, "0") + "-" + (mes + 1).toString().padStart(2, "0");
    }

    function anyoId(anyo, mes) {
      return anyo.toString().padStart(4, "0");
    }

    function cabecera(anyo, mes, nombre) {
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');
      const th = document.createElement('th');
      th.colSpan = 7;
      th.innerHTML = `${capitalizar(nombre)} ${anyo}`;
      th.appendChild(miniMes(mes ? anyo : anyo - 1, mes == 0 ? 11 : mes - 1, 'left'));
      th.appendChild(miniMes(mes == 11 ? anyo + 1 : anyo, mes == 11 ? 0 : mes + 1, 'right'));
      tr.appendChild(th);
      thead.appendChild(tr);
      thead.appendChild(tableRow(nombreDias.map((dia) => `<th>${capitalizar(dia)}</th>`).join("")));
      return thead;
    }

    function tableRow(contenido) {
      const row = document.createElement('tr');
      row.innerHTML = contenido;
      return row;
    }

    function capitalizar(palabra) {
      return palabra[0].toUpperCase() + palabra.slice(1);
    }

    function dias(anyo, mes) {
      const arr = arrayDias(anyo, mes, ponerSiguienteLuna);
      const tbody = document.createElement('tbody');
      for (linea of arr) {
        const tr = document.createElement('tr');
        linea.forEach(td => tr.appendChild(td));
        tbody.appendChild(tr);
      }
      return tbody;
    }

    function arrayDias(anyo, mes, funLunas = () => "") {
      const arr = Array.from({length: 6}, () => []);
      const dia = new Date(anyo, mes);
      for (let linea = 0; linea < 6; linea++) {
        for (let col = 0; col < 7; col++) {
          if (linea == 0 && col < (dia.getDay() + 6) % 7 || dia.getMonth() != mes) {
            arr[linea][col] = document.createElement('td');
          } else {
            const td = document.createElement('td');
            if (lunas[nombreMeses[mes]].includes(dia.getDate())) {
              td.innerHTML = funLunas();
            }
            td.innerHTML += `<span>${dia.getDate()}</span>`;
            td.classList.toggle("festivo", festivos[nombreMeses[mes]].includes(dia.getDate()));
            td.style.cursor = 'pointer';
            td.title = diaId(anyo, mes, dia.getDate());
            td.addEventListener('click', clickFestivo);
            arr[linea][col] = td;
            dia.setDate(dia.getDate() + 1);
          }
        }
      }
      return arr;
    }

    function miniMes(anyo, mes, posicion) {
      const arr = arrayDias(anyo, mes);
      const table = document.createElement('table');
      table.title = mesId(anyo, mes);
      table.classList.add("mini");
      table.style.float = posicion;
      const thead = document.createElement('thead');
      thead.appendChild(tableRow(letrasDias.map(d => '<th>' + d + "</th>").join("")));
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      for (linea of arr) {
        const tr = document.createElement('tr');
        linea.forEach(td => tr.appendChild(td));
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      return table;
    }

    function ponerSiguienteLuna() {
      const lunaActual = posiblesLunas[primeraLuna];
      primeraLuna = Object.keys(posiblesLunas)[(Object.keys(posiblesLunas).indexOf(primeraLuna) + 1) % 4];
      return '<span>' + lunaActual + '</span>';
    }

    function clickFestivo() {
      document.body.querySelectorAll(`[title="${this.title}"]`).forEach(elem => elem.classList.toggle("festivo"));
    }
  </script>
</head>
<body>

<!-- <form id="setup">
  <label>Fechas</label>
  <input type="text" name="text">
</form> -->

<!--   <table>
    <thead>
      <tr>
        <th colspan="7">
          <table class="mini">
            <thead>
              <tr>
                <th>L</th>
                <th>M</th>
                <th>X</th>
                <th>J</th>
                <th>V</th>
                <th>S</th>
                <th>D</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
            </tbody>
          </table>
          Septiembre 2000
          <table class="mini">
            <thead>
              <tr>
                <th>L</th>
                <th>M</th>
                <th>X</th>
                <th>J</th>
                <th>V</th>
                <th>S</th>
                <th>D</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
              <tr>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
                <td>00</td>
              </tr>
            </tbody>
          </table>
        </th>
      </tr>
      <tr>
        <th>Lunes</th>
        <th>Martes</th>
        <th>MiÃ©rcoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
        <th>SÃ¡bado</th>
        <th>Domingo</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
      </tr>
      <tr>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
      </tr>
      <tr>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
      </tr>
      <tr>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
      </tr>
      <tr>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
        <td>00</td>
      </tr>
    </tbody>
  </table> -->

</body>
</html>
